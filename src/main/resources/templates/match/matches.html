<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Í≤ΩÍ∏∞ Î™©Î°ù</title>

    <!-- Bootstrap (local) -->
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script>

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('searchForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const form = e.target;
                const params = new URLSearchParams(new FormData(form)).toString();
                const url = form.action + (params ? '?' + params : '');

                // üî• history Î•º ÏåìÏßÄ ÏïäÍ≥† URL ÍµêÏ≤¥
                window.history.replaceState({}, '', url);

                // Ïã§Ï†ú Ï°∞ÌöåÎäî reload
                window.location.replace(url);
            });


            document.querySelectorAll('.comment-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const comment = btn.dataset.comment;
                    alert(comment && comment.trim() !== '' ? comment : 'ÏΩîÎ©òÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
                });
            });

            document.querySelectorAll(".delete-match-btn").forEach(btn => {
                btn.addEventListener("click", async (e) => {
                    const row = e.target.closest("tr");
                    const matchId = row.dataset.matchId;

                    if (!confirm("Ïù¥ Í≤ΩÍ∏∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                        return;
                    }

                    try {
                        const res = await fetch(`/matches/${matchId}`, {
                            method: "DELETE"
                        });

                        if (!res.ok) {
                            throw new Error();
                        }

                        // ‚úÖ ÌôîÎ©¥ÏóêÏÑú Ï¶âÏãú Ï†úÍ±∞
                        const searchForm = document.getElementById("searchForm");
                        searchForm.requestSubmit();

                    } catch (e) {
                        alert("Í≤ΩÍ∏∞ ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                    }
                });
            });
        });
    </script>
</head>
<body class="bg-light">
<div th:replace="fragments/menu"></div>

<div class="container mt-4">

    <!-- Ï†úÎ™© -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">Í≤ΩÍ∏∞ Î™©Î°ù</h2>
    </div>

    <!-- ================== Ï°∞Í±¥ Í≤ÄÏÉâ ================== -->

    <form id="searchForm"
          th:action="@{/matches}"
          method="get"
          th:object="${query}"
          class="row g-2 mb-3">
<!--    <form th:action="@{/matches}"-->
<!--          method="get"-->
<!--          th:object="${query}"-->
<!--          class="row g-2 mb-3">-->

        <!-- Í≤åÏûÑ ÌÉÄÏûÖ -->
        <div class="col-md-2">
            <select class="form-select" th:field="*{gameMode}">
                <option value="">Ï†ÑÏ≤¥ Í≤åÏûÑ ÌÉÄÏûÖ</option>
                <option th:each="m : ${gameModes}"
                        th:value="${m}"
                        th:text="${m.displayName()}">
                </option>
            </select>
        </div>

        <!-- Îßµ -->
        <div class="col-md-3">
            <select class="form-select" th:field="*{stage}">
                <option value="">Ï†ÑÏ≤¥ Îßµ</option>
                <option th:each="s : ${stages}"
                        th:value="${s}"
                        th:text="${s.displayName()}">
                </option>
            </select>
        </div>

        <!-- ÏÑ† / ÌõÑÍ≥µ -->
        <div class="col-md-2">
            <select class="form-select" th:field="*{turnOrder}">
                <option value="">ÏÑ† / ÌõÑÍ≥µ</option>
                <option th:each="t : ${turnOrders}"
                        th:value="${t}"
                        th:text="${t.label}">
                </option>
            </select>
        </div>
        <div class="col-md-3"></div>
        <!-- Ï°∞Ìöå Î≤ÑÌäº -->
        <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">
                Ï°∞Ìöå
            </button>
        </div>
    </form>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">Ï†ÑÏ≤¥ ÏÑ±Ï†Å</span>
                    <span class="fw-semibold">
                    <span class="text-success fw-bold"
                          th:text="${state.totalWin}">14</span>Ïäπ
                    <span class="text-danger fw-bold ms-1"
                          th:text="${state.totalLose}">6</span>Ìå®
                    <span class="text-muted mx-1">¬∑</span>
                    <span class="fw-bold"
                          th:text="${state.totalRate}">70</span>%
                </span>
                </div>

                <div class="progress mt-1" style="height: 8px;">
                    <div class="progress-bar"
                         role="progressbar"
                         th:classappend="
                        ${state.totalRate} >= 60 ? 'bg-success' :
                        (${state.totalRate} >= 40 ? 'bg-warning' : 'bg-danger')
                     "
                         th:style="'width:' + (${state.totalRate} ?: 0) + '%'">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="mb-3">
                <div class="d-flex justify-content-between">
                    <span class="text-muted">10Í≤ΩÍ∏∞</span>
                    <span class="fw-semibold">
                    <span class="text-success fw-bold"
                          th:text="${state.recentWin()}">14</span>Ïäπ
                    <span class="text-danger fw-bold ms-1"
                          th:text="${state.recentLose()}">6</span>Ìå®
                    <span class="text-muted mx-1">¬∑</span>
                    <span class="fw-bold"
                          th:text="${state.recentRate()}">70</span>%
                </span>
                </div>

                <div class="progress mt-1" style="height: 8px;">
                    <div class="progress-bar"
                         role="progressbar"
                         th:classappend="${state.recentRate()} >= 60 ? 'bg-success' : (${state.recentRate} >= 40 ? 'bg-warning' : 'bg-danger')"
                         th:style="'width:' + (${state.recentRate} ?: 0) + '%'">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ================== Í≤ΩÍ∏∞ Î™©Î°ù ================== -->
    <div class="card shadow-sm">
        <div class="card-body p-0">

            <table class="table table-hover mb-0 align-middle">
                <thead class="table-dark">
                <tr>
                    <th>Í≤ΩÍ∏∞Ïùº</th>
                    <th>ÏÑúÎ≤Ñ</th>
                    <th>ÏÉÅÎåÄ ÌîåÎ†àÏù¥Ïñ¥</th>
                    <th>Í≤åÏûÑ ÌÉÄÏûÖ</th>
                    <th>Îßµ</th>
                    <th>Í≤∞Í≥º</th>
                    <th>ÏÑ†/ÌõÑÍ≥µ</th>
                    <th></th>
                </tr>
                </thead>

                <tbody >
                <tr th:each="m : ${matches}"
                    th:data-match-id="${m.matchId}">
                    <!-- Í≤ΩÍ∏∞ ÎÇ†Ïßú -->
                    <td th:text="${m.relativeDate}">2026-01-01</td>

                    <!-- ÏÑúÎ≤Ñ -->
                    <td>
                        <span class="badge bg-secondary"
                              th:text="${m.opponentPlayer.server.label}">
                            ÏÑúÎ≤Ñ
                        </span>
                    </td>
                    <!-- ÏÉÅÎåÄ ÌîåÎ†àÏù¥Ïñ¥ -->
                    <td>
                        <a th:href="@{/players/{id}(id=${m.opponentPlayer.playerId})}"
                           th:text="${m.opponentPlayer.nickname}">
                            ÎãâÎÑ§ÏûÑ
                        </a>
                    </td>

                    <!-- Í≤åÏûÑ ÌÉÄÏûÖ -->
                    <td th:text="${m.gameMode.displayName()}">Í≤åÏûÑ ÌÉÄÏûÖ</td>

                    <!-- Îßµ -->
                    <td th:text="${m.stage.displayName()}">Îßµ</td>

                    <!-- Í≤∞Í≥º -->
                    <td>
                        <span class="badge"
                              th:text="${m.outcome.label()}"
                              th:classappend="
                                  ${m.outcome.name() == 'WIN'} ? 'bg-success' :
                                  (${m.outcome.name() == 'LOSE'} ? 'bg-danger' : 'bg-secondary')
                              ">
                        </span>
                    </td>

                    <!-- ÏÑ† / ÌõÑÍ≥µ -->
                    <td>
                        <span class="badge turn-order"
                              th:text="${m.turnOrder.label()}"
                              th:classappend="
                                  ${m.turnOrder.name() == 'FIRST'} ? 'bg-primary first' :
                                  (${m.turnOrder.name() == 'SECOND'} ? 'bg-warning text-dark second' : 'bg-secondary')
                              ">
                        </span>
                    </td>

                    <td class="text-end">
                        <div class="btn-group btn-group-sm" role="group">
                            <!-- ÏΩîÎ©òÌä∏ Î≤ÑÌäº -->
                            <button type="button"
                                    class="btn btn-sm comment-btn"
                                    th:data-comment="${m.memo}"
                                    th:classappend="${m.memo != null and !#strings.isEmpty(m.memo)}
                                                        ? 'btn-outline-primary'
                                                        : 'btn-outline-secondary'">
                                ÏΩîÎ©òÌä∏
                            </button>

                            <!-- ÏÇ≠Ï†ú Î≤ÑÌäº -->
                            <button type="button"
                                    class="btn btn-outline-danger delete-match-btn">
                                ÏÇ≠Ï†ú
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- empty -->
                <tr th:if="${#lists.isEmpty(matches)}">
                    <td colspan="7" class="text-center text-muted py-4">
                        Îì±Î°ùÎêú Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                    </td>
                </tr>
                </tbody>
            </table>

        </div>
    </div>

</div>

</body>
</html>
